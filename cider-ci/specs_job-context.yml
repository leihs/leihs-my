generate_tasks:
  include_match: spec/.*_spec.rb
task_defaults:
  include:
    - path: cider-ci/task-components/database.yml
      submodule: [database]
    - cider-ci/ruby-bundle_task-component.yml
    - cider-ci/service_task-component.yml
    - cider-ci/test-auth-system_task-component.yml
    - cider-ci/uberjar_task-component.yml
  ports:
    LEIHS_MY_HTTP_PORT:
      min: 3240
      max: 3249
    TEST_AUTH_SYSTEM_PORT:
      min: 3240
      max: 3249
  environment_variables:
    LEIHS_DATABASE_NAME: leihs_{{CIDER_CI_TRIAL_ID}}
    DB_NAME: "{{LEIHS_DATABASE_NAME}}"
    LEIHS_MY_DIR: '{{CIDER_CI_WORKING_DIR}}'
    LEIHS_DATABASE_DIR: '{{LEIHS_MY_DIR}}/database'
    LEIHS_MY_HTTP_HOST: localhost
    LEIHS_MY_HTTP_BASE_URL: http://{{LEIHS_MY_HTTP_HOST}}:{{LEIHS_MY_HTTP_PORT}}
    RAILS_ENV: test
    RUBY: '{{RUBY_ENGINE}}-{{RUBY_VERSION}}'
    RUBY_ENGINE: ruby
    RUBY_VERSION: 2.7.5
    RUBY_BUNDLER_VERSION: 2.3.3
  git_options:
    submodules:
      include_match: ^.*$
  trial_attachments:
    screenshots:
      include_match: '^tmp\/screenshots\/.+\.png$'
      content_type: image/png
  scripts:
    test:
      body: |
        #!/usr/bin/env bash
        set -eux
        export PATH=~/.rubies/$RUBY/bin:$PATH
        mkdir -p log
        xvfb-run -a -e log/xvfb.log bundle exec rspec $CIDER_CI_TASK_FILE
